{% load static precios %}
<article class='group rounded-2xl border border-base-border bg-base-surface shadow-card transition hover:-translate-y-1 hover:shadow-md'>
  <a href="{% url 'catalogo:producto_detalle' slug=producto.slug %}" class='block p-3'>
    <div class='rounded-2xl border-2 border-dashed border-base-border bg-white'>
      {% if producto.imagen %}
        <img src='{{ producto.imagen.url }}' alt='{{ producto.nombre }}'
             loading='lazy' class='aspect-square w-full object-cover' />
      {% else %}
        <div class='flex aspect-square items-center justify-center text-base-sub'>
          <i class='fas fa-image text-2xl'></i>
        </div>
      {% endif %}
    </div>
  </a>

  <div class='space-y-3 px-4 pb-5'>
    <h3 class='line-clamp-2 text-sm font-semibold text-base-fg transition group-hover:text-brand'>
      <a href="{% url 'catalogo:producto_detalle' slug=producto.slug %}">{{ producto.nombre }}</a>
    </h3>
    <p class='line-clamp-2 text-xs text-base-sub'>{{ producto.descripcion|truncatechars:90 }}</p>

    {% with m=moneda_actual %}
      {% if m and m != producto.moneda_precio %}
        {% precio_en_moneda producto m as precio_convertido %}
        <div class='flex items-baseline gap-2'>
          <span class='text-lg font-semibold text-brand'>{{ simbolo_moneda }}{{ precio_convertido|floatformat:2 }}</span>
          <span class='text-xs text-base-sub'>({{ producto.precio_formateado }})</span>
        </div>
      {% else %}
        <span class='text-lg font-semibold text-brand'>{{ producto.precio_formateado }}</span>
      {% endif %}
    {% endwith %}

    {% if producto.stock_bajo %}
      <p class='text-xs font-medium text-danger'>Stock bajo</p>
    {% endif %}

    <form action="{% url 'pedidos:carrito_agregar' %}" method='post' class='flex items-center justify-between gap-2'>
      {% csrf_token %}
      <input type='hidden' name='product_id' value='{{ producto.id }}' />
      <div class='inline-flex items-center rounded-full border border-base-border'>
        <button type='button'
                class='px-3 py-1 text-base-sub hover:text-brand focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand/50'
                onclick="var q=this.nextElementSibling; if(+q.value>1){q.value=+q.value-1;}">-</button>
        <input type='number' name='quantity' min='1' value='1'
               class='h-9 w-12 border-0 text-center text-sm text-base-fg focus:outline-none focus:ring-0' />
        <button type='button'
                class='px-3 py-1 text-base-sub hover:text-brand focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand/50'
                onclick="var q=this.previousElementSibling; q.value=+q.value+1;">+</button>
      </div>
      <button type='submit'
              class='inline-flex items-center justify-center rounded-xl bg-brand px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-brand-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand/70'>
        <i class='fas fa-shopping-cart mr-2 text-xs'></i>
        Añadir
      </button>
    </form>
  </div>
</article>
