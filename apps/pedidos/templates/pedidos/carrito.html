{% extends 'base.html' %}

{% block title %}Carrito{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10">
  {% if items %}
    <div class="flex flex-col gap-8 lg:flex-row">
      <section class="w-full space-y-6 lg:w-2/3">
        <div class="rounded-2xl border border-base-border bg-base-bg p-6 shadow-card">
          <h1 class="text-2xl font-semibold text-brand">Tu carrito de compras</h1>
        </div>

        {% for it in items %}
        <article class="flex flex-col gap-4 rounded-2xl border border-base-border bg-white p-5 shadow-sm sm:flex-row">
          <div class="flex h-40 w-full flex-shrink-0 items-center justify-center rounded-2xl border-2 border-dashed border-base-border bg-base-surface sm:h-32 sm:w-32">
            {% if it.producto.imagen %}
              <img src="{{ it.producto.imagen.url }}" alt="{{ it.producto.nombre }}"
                   loading="lazy" class="h-full w-full object-contain" />
            {% else %}
              <i class="fas fa-image text-2xl text-base-sub"></i>
            {% endif %}
          </div>

          <div class="flex flex-1 flex-col justify-between gap-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0 space-y-1">
                <h2 class="line-clamp-2 text-lg font-semibold text-base-fg">{{ it.producto.nombre }}</h2>
                {% if it.producto.categoria %}
                  <p class="text-xs text-base-sub">Categoría: {{ it.producto.categoria.nombre }}</p>
                {% endif %}
              </div>
              <form action="{% url 'pedidos:carrito_eliminar' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ it.producto.id }}" />
                <button class="text-base-sub transition hover:text-danger" aria-label="Eliminar del carrito">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </div>

            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div class="flex items-center gap-4">
                <div>
                  <p class="text-lg font-semibold text-brand">{{ simbolo_moneda }}{{ it.precio_convertido|floatformat:2 }}</p>
                  <p class="text-xs text-base-sub">({{ it.producto.precio_formateado }})</p>
                </div>
                <form action="{% url 'pedidos:carrito_actualizar' %}" method="post"
                      class="inline-flex items-center rounded-full border border-base-border">
                  {% csrf_token %}
                  <input type="hidden" name="product_id" value="{{ it.producto.id }}" />
                  <button type="button"
                          class="px-4 py-2 text-base-sub hover:text-brand"
                          onclick="var q=this.nextElementSibling; var v=Math.max(0,(+q.value||0)-1); q.value=v; this.form.submit();">−</button>
                  <input type="number" name="quantity" min="0" value="{{ it.cantidad }}"
                         class="h-10 w-14 border-0 text-center text-sm text-base-fg focus:outline-none focus:ring-0"
                         onchange="this.form.submit()" />
                  <button type="button"
                          class="px-4 py-2 text-base-sub hover:text-brand"
                          onclick="var q=this.previousElementSibling; q.value=(+q.value||0)+1; this.form.submit();">+</button>
                </form>
              </div>
              <div class="text-right">
                <p class="text-xs text-base-sub">Subtotal</p>
                <p class="text-lg font-semibold text-brand">${{ it.subtotal }}</p>
                <p class="text-xs text-base-sub">{{ simbolo_moneda }}{{ it.subtotal_convertido|floatformat:2 }}</p>
              </div>
            </div>
          </div>
        </article>
        {% endfor %}

        <div class="rounded-2xl border border-base-border bg-brand/5 p-6 shadow-sm">
          <h3 class="text-base font-semibold text-brand">¿Tienes un código de descuento?</h3>
          <div class="mt-3 flex flex-col gap-2 sm:flex-row">
            <input type="text" placeholder="Ingresa tu código"
                   class="flex-1 rounded-xl border border-base-border bg-white px-4 py-2 text-sm focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/40" />
            <button type="button"
                    class="inline-flex items-center justify-center rounded-xl border border-brand px-5 py-2 text-sm font-semibold text-brand transition hover:bg-brand hover:text-white focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand/60">
              Aplicar
            </button>
          </div>
        </div>

        <form action="{% url 'pedidos:carrito_limpiar' %}" method="post">
          {% csrf_token %}
          <button class="text-sm text-base-sub underline-offset-4 transition hover:text-brand hover:underline">
            Vaciar carrito
          </button>
        </form>
      </section>

      <aside class="w-full lg:w-1/3">
        <div class="sticky top-24 space-y-6 rounded-2xl border border-base-border bg-base-bg p-6 shadow-card">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold text-base-fg">Resumen de compra</h2>
            <i class="fas fa-receipt text-brand"></i>
          </div>
          <div class="space-y-3 text-sm text-base-sub">
            <div class="flex justify-between">
              <span>Subtotal ({{ cart_count|default:0 }} productos)</span>
              <span class="font-medium text-base-fg">${{ total }}</span>
            </div>
            <div class="flex justify-between">
              <span>Descuento</span>
              <span class="font-medium text-success">-$0.00</span>
            </div>
            <div class="flex justify-between">
              <span>Envío</span>
              <span class="font-medium text-base-fg">Gratis</span>
            </div>
            <div class="border-t border-base-border pt-4 text-base-fg">
              <div class="flex justify-between text-lg font-semibold">
                <span>Total</span>
                <span>${{ total }}</span>
              </div>
              <p class="text-xs text-base-sub">Equivalente: {{ simbolo_moneda }}{{ total_convertido|floatformat:2 }}</p>
            </div>
          </div>

          <div class="space-y-3">
            <h3 class="text-sm font-semibold text-base-fg">Métodos de pago</h3>
            <div class="flex flex-wrap gap-2">
              <span class="inline-flex items-center rounded-lg bg-base-surface px-3 py-2 text-base-sub"><i class="fab fa-cc-visa text-blue-700"></i></span>
              <span class="inline-flex items-center rounded-lg bg-base-surface px-3 py-2 text-base-sub"><i class="fab fa-cc-mastercard text-red-600"></i></span>
              <span class="inline-flex items-center rounded-lg bg-base-surface px-3 py-2 text-base-sub"><i class="fab fa-cc-paypal text-blue-500"></i></span>
              <span class="inline-flex items-center rounded-lg bg-base-surface px-3 py-2 text-base-sub"><i class="fas fa-money-bill-wave text-green-600"></i></span>
            </div>
          </div>

          <a href="{% url 'pedidos:checkout' %}"
             class="inline-flex w-full items-center justify-center rounded-xl bg-accent px-5 py-3 text-base font-semibold text-slate-900 shadow transition hover:bg-accent-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-300">
            <i class="fas fa-lock mr-2"></i> Proceder al pago
          </a>

          <div class="space-y-4 border-t border-base-border pt-4 text-sm text-base-sub">
            <div class="flex items-start gap-3">
              <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-brand/10 text-brand">
                <i class="fas fa-shield-alt"></i>
              </span>
              <div>
                <h4 class="font-semibold text-base-fg">Compra segura</h4>
                <p>Tu información está protegida con cifrado SSL y verificación manual.</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-brand/10 text-brand">
                <i class="fas fa-undo"></i>
              </span>
              <div>
                <h4 class="font-semibold text-base-fg">Devoluciones fáciles</h4>
                <p>30 días para cambios o devoluciones con comprobante.</p>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  {% else %}
    <div class="rounded-2xl border border-base-border bg-white p-8 text-center text-base-sub shadow-sm">
      Tu carrito está vacío.
    </div>
  {% endif %}
</div>
{% endblock %}
